name: "Setup HTTPS with cert-manager"

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Application name'
        required: true
        type: string
        default: 'voting-app'
      environment:
        description: 'Target environment'
        required: true
        type: string
        default: 'dev'
      tenant:
        description: 'Tenant name'
        required: true
        type: string
        default: 'opsera'

env:
  AWS_REGION: us-west-2
  APP_NAME: ${{ github.event.inputs.app_name || 'voting-app' }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
  TENANT: ${{ github.event.inputs.tenant || 'opsera' }}
  DOMAIN: agent.opsera.dev
  SPOKE_CLUSTER: opsera-usw2-np

permissions:
  contents: read
  id-token: write

jobs:
  setup-https:
    name: "Setup HTTPS with Let's Encrypt"
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Connect to Spoke Cluster
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          KUBECTL="./kubectl"

          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          $KUBECTL cluster-info

      - name: Checkpoint 1 - Verify cert-manager Installed
        run: |
          KUBECTL="./kubectl"

          echo "╔═══════════════════════════════════════════════════╗"
          echo "║  CHECKPOINT 1: Verify cert-manager                ║"
          echo "╚═══════════════════════════════════════════════════╝"

          if $KUBECTL get namespace cert-manager 2>/dev/null; then
            echo "cert-manager namespace exists"
            $KUBECTL get pods -n cert-manager
          else
            echo "Installing cert-manager..."
            $KUBECTL apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.14.0/cert-manager.yaml
            sleep 60
            $KUBECTL wait --for=condition=ready pod -l app=cert-manager -n cert-manager --timeout=120s
          fi

      - name: Checkpoint 2 - Create ClusterIssuer
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          KUBECTL="./kubectl"

          echo "╔═══════════════════════════════════════════════════╗"
          echo "║  CHECKPOINT 2: Create ClusterIssuer               ║"
          echo "╚═══════════════════════════════════════════════════╝"

          # Get hosted zone ID
          HOSTED_ZONE_ID=$(aws route53 list-hosted-zones-by-name \
            --dns-name "${{ env.DOMAIN }}" \
            --query "HostedZones[?Name=='${{ env.DOMAIN }}.'].Id" \
            --output text | sed 's|/hostedzone/||')

          if [ -z "$HOSTED_ZONE_ID" ]; then
            echo "ERROR: Hosted zone for ${{ env.DOMAIN }} not found"
            exit 1
          fi

          echo "Hosted Zone ID: $HOSTED_ZONE_ID"

          # Create Route53 credentials secret
          if ! $KUBECTL get secret route53-credentials -n cert-manager 2>/dev/null; then
            $KUBECTL create secret generic route53-credentials \
              -n cert-manager \
              --from-literal=secret-access-key="${AWS_SECRET_ACCESS_KEY}"
            echo "Created Route53 credentials secret"
          fi

          # Create ClusterIssuer
          cat <<EOF | $KUBECTL apply -f -
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: letsencrypt-prod
          spec:
            acme:
              server: https://acme-v02.api.letsencrypt.org/directory
              email: devops@opsera.io
              privateKeySecretRef:
                name: letsencrypt-prod-account-key
              solvers:
              - selector:
                  dnsZones:
                    - "${{ env.DOMAIN }}"
                dns01:
                  route53:
                    region: ${{ env.AWS_REGION }}
                    hostedZoneID: ${HOSTED_ZONE_ID}
                    accessKeyID: ${AWS_ACCESS_KEY_ID}
                    secretAccessKeySecretRef:
                      name: route53-credentials
                      key: secret-access-key
          EOF

          echo "ClusterIssuer created/updated"

      - name: Checkpoint 3 - Verify Application Running
        run: |
          KUBECTL="./kubectl"
          NAMESPACE="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"

          echo "╔═══════════════════════════════════════════════════╗"
          echo "║  CHECKPOINT 3: Verify Application Running         ║"
          echo "╚═══════════════════════════════════════════════════╝"

          # Wait for pods to be ready
          $KUBECTL get pods -n "$NAMESPACE" || {
            echo "Namespace $NAMESPACE not found. Application may not be deployed yet."
            exit 0
          }

          # Check if services exist
          $KUBECTL get svc -n "$NAMESPACE"

      - name: Checkpoint 4 - Verify Ingress Created
        run: |
          KUBECTL="./kubectl"
          NAMESPACE="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"

          echo "╔═══════════════════════════════════════════════════╗"
          echo "║  CHECKPOINT 4: Verify Ingress                     ║"
          echo "╚═══════════════════════════════════════════════════╝"

          $KUBECTL get ingress -n "$NAMESPACE" || echo "No ingress found"

      - name: Checkpoint 5 - Wait for Certificate
        run: |
          KUBECTL="./kubectl"
          NAMESPACE="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          SUBDOMAIN="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}.${{ env.DOMAIN }}"

          echo "╔═══════════════════════════════════════════════════╗"
          echo "║  CHECKPOINT 5: Wait for Certificate               ║"
          echo "╚═══════════════════════════════════════════════════╝"

          MAX_ATTEMPTS=30
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            CERT_STATUS=$($KUBECTL get certificate -n "$NAMESPACE" \
              -o jsonpath='{.items[0].status.conditions[?(@.type=="Ready")].status}' 2>/dev/null || echo "NotFound")

            echo "[$ATTEMPT/$MAX_ATTEMPTS] Certificate status: $CERT_STATUS"

            if [ "$CERT_STATUS" = "True" ]; then
              echo "Certificate is ready!"
              break
            fi

            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          $KUBECTL get certificate -n "$NAMESPACE" || echo "No certificates found"

      - name: Checkpoint 6 - Verify HTTPS Endpoint
        run: |
          SUBDOMAIN="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}.${{ env.DOMAIN }}"

          echo "╔═══════════════════════════════════════════════════╗"
          echo "║  CHECKPOINT 6: Verify HTTPS Endpoint              ║"
          echo "╚═══════════════════════════════════════════════════╝"

          # Wait for DNS propagation
          sleep 30

          HTTPS_URL="https://${SUBDOMAIN}"

          # Test HTTPS endpoint
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HTTPS_URL" -k --max-time 10 || echo "000")

          echo "HTTPS endpoint: $HTTPS_URL"
          echo "HTTP status code: $HTTP_CODE"

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "HTTPS endpoint is accessible!"
          else
            echo "WARNING: HTTPS endpoint returned status $HTTP_CODE"
            echo "This may be normal if DNS is still propagating"
          fi

      - name: HTTPS Setup Summary
        run: |
          SUBDOMAIN="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}.${{ env.DOMAIN }}"

          echo "## HTTPS Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- **Vote UI**: https://${SUBDOMAIN}/" >> $GITHUB_STEP_SUMMARY
          echo "- **Results**: https://${SUBDOMAIN}/results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Certificate" >> $GITHUB_STEP_SUMMARY
          echo "- **Issuer**: Let's Encrypt (Production)" >> $GITHUB_STEP_SUMMARY
          echo "- **Validity**: 90 days (auto-renewed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Notes" >> $GITHUB_STEP_SUMMARY
          echo "- Certificate issuance may take 2-5 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- DNS propagation may take up to 5 minutes" >> $GITHUB_STEP_SUMMARY
