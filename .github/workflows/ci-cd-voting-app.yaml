name: "CI/CD - Voting App Enterprise Pipeline"

on:
  push:
    branches: [main]
    paths:
      - 'vote/**'
      - 'result/**'
      - 'worker/**'
      - '.opsera-voting-app/Dockerfile.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: string
        default: 'dev'
      skip_quality_gates:
        description: 'Skip quality gates (emergency deployments only)'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: us-west-2
  APP_NAME: voting-app
  TENANT: opsera

permissions:
  contents: write
  id-token: write
  security-events: write

jobs:
  # ============================================
  # STAGE 1: Verify Prerequisites
  # ============================================
  verify-prerequisites:
    name: "Verify Prerequisites"
    runs-on: ubuntu-latest
    outputs:
      ecr_uri: ${{ steps.ecr.outputs.ecr_uri }}
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - name: Set Environment
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          echo "environment=${ENV}" >> $GITHUB_OUTPUT

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get ECR URI
        id: ecr
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          echo "ecr_uri=${ECR_URI}" >> $GITHUB_OUTPUT
          echo "ECR URI: ${ECR_URI}"

      - name: Create ECR Repositories (if not exist)
        run: |
          for SERVICE in vote result worker; do
            aws ecr describe-repositories --repository-names "$SERVICE" 2>/dev/null || \
            aws ecr create-repository \
              --repository-name "$SERVICE" \
              --image-scanning-configuration scanOnPush=true \
              --encryption-configuration encryptionType=AES256
            echo "ECR repository ready: $SERVICE"
          done

  # ============================================
  # STAGE 2: Security Scanning (Quality Gate)
  # ============================================
  security-scan:
    name: "Security Scan - ${{ matrix.service }}"
    runs-on: ubuntu-latest
    needs: [verify-prerequisites]
    if: ${{ github.event.inputs.skip_quality_gates != 'true' }}
    strategy:
      matrix:
        service: [vote, result, worker]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build Image for Scanning
        run: |
          if [ "${{ matrix.service }}" = "vote" ]; then
            docker build -t ${{ matrix.service }}:scan \
              -f .opsera-voting-app/Dockerfile.vote .
          elif [ "${{ matrix.service }}" = "result" ]; then
            docker build -t ${{ matrix.service }}:scan \
              -f .opsera-voting-app/Dockerfile.result .
          else
            docker build -t ${{ matrix.service }}:scan \
              -f .opsera-voting-app/Dockerfile.worker .
          fi

      - name: Run Grype Vulnerability Scan
        uses: anchore/scan-action@v3
        id: scan
        with:
          image: "${{ matrix.service }}:scan"
          fail-build: true
          severity-cutoff: high
          output-format: sarif

      - name: Upload Scan Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }}
          category: "grype-${{ matrix.service }}"

      - name: Security Scan Summary
        run: |
          echo "### Security Scan Results - ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "Scan completed. Results uploaded to GitHub Security tab." >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 3: Code Quality (SonarQube)
  # ============================================
  code-quality:
    name: "Code Quality Analysis"
    runs-on: ubuntu-latest
    needs: [verify-prerequisites]
    if: ${{ github.event.inputs.skip_quality_gates != 'true' }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run SonarQube Scan
        if: ${{ vars.SONAR_HOST_URL != '' }}
        uses: SonarSource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=voting-app
            -Dsonar.sources=vote,result,worker
            -Dsonar.python.version=3.11

      - name: Code Quality Summary
        run: |
          echo "### Code Quality Analysis" >> $GITHUB_STEP_SUMMARY
          if [ -z "${{ vars.SONAR_HOST_URL }}" ]; then
            echo "SonarQube not configured. Skipping quality analysis." >> $GITHUB_STEP_SUMMARY
          else
            echo "SonarQube scan completed. Check SonarQube dashboard for results." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # STAGE 4: Build and Push Images
  # ============================================
  build-and-push:
    name: "Build & Push - ${{ matrix.service }}"
    runs-on: ubuntu-latest
    needs: [verify-prerequisites, security-scan, code-quality]
    if: always() && needs.verify-prerequisites.result == 'success' && (needs.security-scan.result == 'success' || needs.security-scan.result == 'skipped') && (needs.code-quality.result == 'success' || needs.code-quality.result == 'skipped')
    strategy:
      matrix:
        service: [vote, result, worker]
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push
        id: build
        env:
          ECR_URI: ${{ needs.verify-prerequisites.outputs.ecr_uri }}
        run: |
          IMAGE_TAG="${GITHUB_SHA:0:7}-$(date +%Y%m%d%H%M%S)"
          FULL_IMAGE="${ECR_URI}/${{ matrix.service }}:${IMAGE_TAG}"
          LATEST_IMAGE="${ECR_URI}/${{ matrix.service }}:latest"

          echo "Building: $FULL_IMAGE"

          if [ "${{ matrix.service }}" = "vote" ]; then
            docker build -t "$FULL_IMAGE" -t "$LATEST_IMAGE" \
              -f .opsera-voting-app/Dockerfile.vote .
          elif [ "${{ matrix.service }}" = "result" ]; then
            docker build -t "$FULL_IMAGE" -t "$LATEST_IMAGE" \
              -f .opsera-voting-app/Dockerfile.result .
          else
            docker build -t "$FULL_IMAGE" -t "$LATEST_IMAGE" \
              -f .opsera-voting-app/Dockerfile.worker .
          fi

          docker push "$FULL_IMAGE"
          docker push "$LATEST_IMAGE"

          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "### Build Complete - ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "Image: \`${FULL_IMAGE}\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 5: Update Kustomize Manifests
  # ============================================
  update-kustomize:
    name: "Update Kustomize Manifests"
    runs-on: ubuntu-latest
    needs: [verify-prerequisites, build-and-push]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Update Kustomization
        env:
          ECR_URI: ${{ needs.verify-prerequisites.outputs.ecr_uri }}
          ENV: ${{ needs.verify-prerequisites.outputs.environment }}
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
        run: |
          KUSTOMIZE_FILE=".opsera-voting-app/k8s/overlays/${ENV}/kustomization.yaml"

          # Pull latest changes first (RULE 8)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main || true

          # Update image references
          for SERVICE in vote result worker; do
            sed -i "s|newName: .*/vote|newName: ${ECR_URI}/vote|" "$KUSTOMIZE_FILE"
            sed -i "s|newName: .*/result|newName: ${ECR_URI}/result|" "$KUSTOMIZE_FILE"
            sed -i "s|newName: .*/worker|newName: ${ECR_URI}/worker|" "$KUSTOMIZE_FILE"
          done

          # Update all image tags
          sed -i "s|newTag: .*|newTag: ${IMAGE_TAG}|g" "$KUSTOMIZE_FILE"

          # Commit and push
          git add "$KUSTOMIZE_FILE"
          git commit -m "chore: update images to ${IMAGE_TAG} [skip ci]" || echo "No changes to commit"
          git push origin main

          echo "### Kustomize Updated" >> $GITHUB_STEP_SUMMARY
          echo "Environment: ${ENV}" >> $GITHUB_STEP_SUMMARY
          echo "Image Tag: ${IMAGE_TAG}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 6: Verify ArgoCD Sync
  # ============================================
  verify-argocd-sync:
    name: "Verify ArgoCD Sync"
    runs-on: ubuntu-latest
    needs: [verify-prerequisites, update-kustomize]
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check ArgoCD Application Status
        env:
          ENV: ${{ needs.verify-prerequisites.outputs.environment }}
        run: |
          # Install kubectl
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          KUBECTL="./kubectl"

          # Connect to hub cluster
          aws eks update-kubeconfig --name argocd-usw2 --region ${{ env.AWS_REGION }} || {
            echo "Hub cluster not found. Skipping ArgoCD verification."
            exit 0
          }

          APP_NAME="${{ env.APP_NAME }}-${ENV}"

          # Wait for sync (max 5 minutes)
          MAX_ATTEMPTS=30
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            SYNC_STATUS=$($KUBECTL get application "${APP_NAME}" -n argocd \
              -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "NotFound")

            HEALTH_STATUS=$($KUBECTL get application "${APP_NAME}" -n argocd \
              -o jsonpath='{.status.health.status}' 2>/dev/null || echo "NotFound")

            echo "[$ATTEMPT/$MAX_ATTEMPTS] Sync: ${SYNC_STATUS}, Health: ${HEALTH_STATUS}"

            if [ "$SYNC_STATUS" = "Synced" ] && [ "$HEALTH_STATUS" = "Healthy" ]; then
              echo "Application is synced and healthy!"
              break
            fi

            if [ "$SYNC_STATUS" = "Unknown" ]; then
              echo "ERROR: ArgoCD cannot access repository. Check configuration."
              exit 1
            fi

            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "### Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "- Sync Status: ${SYNC_STATUS}" >> $GITHUB_STEP_SUMMARY
          echo "- Health Status: ${HEALTH_STATUS}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 7: Deployment Summary
  # ============================================
  deployment-summary:
    name: "Deployment Summary"
    runs-on: ubuntu-latest
    needs: [verify-prerequisites, build-and-push, verify-argocd-sync]
    if: always()
    steps:
      - name: Generate Summary
        env:
          ENV: ${{ needs.verify-prerequisites.outputs.environment }}
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
        run: |
          echo "## Voting App Enterprise Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${ENV} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${IMAGE_TAG} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quality Gates" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan (Grype): ${{ needs.security-scan.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality (SonarQube): ${{ needs.code-quality.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- vote (Python Flask)" >> $GITHUB_STEP_SUMMARY
          echo "- result (Node.js)" >> $GITHUB_STEP_SUMMARY
          echo "- worker (.NET Core)" >> $GITHUB_STEP_SUMMARY
          echo "- redis (StatefulSet)" >> $GITHUB_STEP_SUMMARY
          echo "- postgres (StatefulSet)" >> $GITHUB_STEP_SUMMARY
