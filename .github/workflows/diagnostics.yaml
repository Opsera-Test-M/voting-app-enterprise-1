name: "Diagnostics - ArgoCD & K8s Health Check"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: string
        default: 'dev'
      check_type:
        description: 'Type of diagnostic check'
        required: true
        type: choice
        options:
          - full
          - argocd-only
          - pods-only
          - logs-only
        default: 'full'

env:
  AWS_REGION: us-west-2
  APP_NAME: voting-app
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np

permissions:
  contents: read
  id-token: write

jobs:
  diagnostics:
    name: "Run Diagnostics"
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      # ============================================
      # ArgoCD Diagnostics
      # ============================================
      - name: ArgoCD - Application Status
        if: ${{ github.event.inputs.check_type == 'full' || github.event.inputs.check_type == 'argocd-only' }}
        run: |
          echo "## ArgoCD Application Status" >> $GITHUB_STEP_SUMMARY

          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}

          APP_NAME="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          echo "### Application: ${APP_NAME}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Get sync and health status
          SYNC_STATUS=$(kubectl get application "${APP_NAME}" -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "NotFound")
          HEALTH_STATUS=$(kubectl get application "${APP_NAME}" -n argocd -o jsonpath='{.status.health.status}' 2>/dev/null || echo "NotFound")
          REVISION=$(kubectl get application "${APP_NAME}" -n argocd -o jsonpath='{.status.sync.revision}' 2>/dev/null || echo "Unknown")

          echo "Sync Status: ${SYNC_STATUS}" >> $GITHUB_STEP_SUMMARY
          echo "Health Status: ${HEALTH_STATUS}" >> $GITHUB_STEP_SUMMARY
          echo "Current Revision: ${REVISION:0:7}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Check for sync errors
          SYNC_ERROR=$(kubectl get application "${APP_NAME}" -n argocd -o jsonpath='{.status.conditions[?(@.type=="SyncError")].message}' 2>/dev/null)
          if [ -n "$SYNC_ERROR" ]; then
            echo "### Sync Error" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$SYNC_ERROR" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: ArgoCD - Resource Status
        if: ${{ github.event.inputs.check_type == 'full' || github.event.inputs.check_type == 'argocd-only' }}
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}

          APP_NAME="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          echo "### ArgoCD Managed Resources" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get application "${APP_NAME}" -n argocd -o jsonpath='{range .status.resources[*]}{.kind}/{.name}: {.status} ({.health.status}){"\n"}{end}' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Could not fetch resources"
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ============================================
      # Pod Diagnostics
      # ============================================
      - name: Pods - Status Check
        if: ${{ github.event.inputs.check_type == 'full' || github.event.inputs.check_type == 'pods-only' }}
        run: |
          echo "## Pod Status" >> $GITHUB_STEP_SUMMARY

          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

          NAMESPACE="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          echo "### Namespace: ${NAMESPACE}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n "${NAMESPACE}" -o wide 2>/dev/null || echo "Namespace not found or no pods"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Pods - Describe Failing Pods
        if: ${{ github.event.inputs.check_type == 'full' || github.event.inputs.check_type == 'pods-only' }}
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

          NAMESPACE="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          # Find pods not in Running/Completed state
          FAILING_PODS=$(kubectl get pods -n "${NAMESPACE}" --no-headers 2>/dev/null | grep -v "Running\|Completed" | awk '{print $1}')

          if [ -n "$FAILING_PODS" ]; then
            echo "### Failing Pod Details" >> $GITHUB_STEP_SUMMARY
            for POD in $FAILING_PODS; do
              echo "#### Pod: ${POD}" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              kubectl describe pod "${POD}" -n "${NAMESPACE}" 2>/dev/null | tail -30
              echo '```' >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "### All pods are healthy" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Services - Status Check
        if: ${{ github.event.inputs.check_type == 'full' || github.event.inputs.check_type == 'pods-only' }}
        run: |
          echo "## Services" >> $GITHUB_STEP_SUMMARY

          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

          NAMESPACE="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get svc -n "${NAMESPACE}" 2>/dev/null || echo "No services found"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: StatefulSets & PVCs
        if: ${{ github.event.inputs.check_type == 'full' || github.event.inputs.check_type == 'pods-only' }}
        run: |
          echo "## StatefulSets & Storage" >> $GITHUB_STEP_SUMMARY

          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

          NAMESPACE="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          echo "### StatefulSets" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get statefulsets -n "${NAMESPACE}" 2>/dev/null || echo "No statefulsets found"
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "### PersistentVolumeClaims" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pvc -n "${NAMESPACE}" 2>/dev/null || echo "No PVCs found"
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ============================================
      # Log Diagnostics
      # ============================================
      - name: Logs - Application Pods
        if: ${{ github.event.inputs.check_type == 'full' || github.event.inputs.check_type == 'logs-only' }}
        run: |
          echo "## Application Logs (last 50 lines)" >> $GITHUB_STEP_SUMMARY

          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

          NAMESPACE="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          for DEPLOY in vote result worker; do
            echo "### ${DEPLOY}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl logs deploy/${DEPLOY} -n "${NAMESPACE}" --tail=50 2>&1 || echo "Could not fetch logs"
            echo '```' >> $GITHUB_STEP_SUMMARY
          done

      - name: Logs - Database Pods
        if: ${{ github.event.inputs.check_type == 'full' || github.event.inputs.check_type == 'logs-only' }}
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

          NAMESPACE="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          for STS in redis db; do
            echo "### ${STS}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl logs "${STS}-0" -n "${NAMESPACE}" --tail=30 2>&1 || echo "Could not fetch logs"
            echo '```' >> $GITHUB_STEP_SUMMARY
          done

      # ============================================
      # Ingress & Networking
      # ============================================
      - name: Ingress Status
        if: ${{ github.event.inputs.check_type == 'full' }}
        run: |
          echo "## Ingress" >> $GITHUB_STEP_SUMMARY

          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

          NAMESPACE="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get ingress -n "${NAMESPACE}" 2>/dev/null || echo "No ingress found"
          echo '```' >> $GITHUB_STEP_SUMMARY

          kubectl describe ingress -n "${NAMESPACE}" 2>/dev/null | head -50 >> $GITHUB_STEP_SUMMARY || true

      - name: Events (last 10 minutes)
        if: ${{ github.event.inputs.check_type == 'full' }}
        run: |
          echo "## Recent Events" >> $GITHUB_STEP_SUMMARY

          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

          NAMESPACE="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get events -n "${NAMESPACE}" --sort-by='.lastTimestamp' 2>/dev/null | tail -20 || echo "No events"
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ============================================
      # Summary
      # ============================================
      - name: Generate Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## Quick Reference" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Check Type**: ${{ github.event.inputs.check_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Troubleshooting Commands" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Connect to spoke cluster" >> $GITHUB_STEP_SUMMARY
          echo "aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Port forward to debug locally" >> $GITHUB_STEP_SUMMARY
          echo "kubectl port-forward svc/vote 8080:80 -n ${{ env.APP_NAME }}-${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
